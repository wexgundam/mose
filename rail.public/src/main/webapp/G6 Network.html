<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>G6 Network</title>
    <script src="https://gw.alipayobjects.com/os/antv/pkg/_antv.g6-3.5.6/dist/g6.min.js"></script>
    <script src="assets/g6/polygon.js"></script>
    <style>
        .g6-minimap-container {
            border: 1px solid #e2e2e2;
        }

        .g6-minimap-viewport {
            border: 2px solid rgb(25, 128, 255);
        }
    </style>
</head>
<body style="overflow-x: hidden;overflow-y: hidden">
    <div id="mountNode"></div>
    <script>
        //背景图片
        G6.registerCombo('backgroundCombo', {
            drawShape(cfg, group) {
                // Get the padding from the configuration
                cfg.padding = [0, 0, 0, 0];
                const image = group.addShape('rect', {
                    attrs: {
                        x: -cfg.width / 2,
                        y: -cfg.height / 2,
                        width: cfg.width,
                        height: cfg.height,
                        fill: 'red',
                        stroke: 'red',
                        fillOpacity: 0,
                        strokeOpacity: 0,
                    },
                    draggable: true,
                    name: 'combo-background'
                });
                return image;
            },
        }, 'rect');

        //背景边界
        G6.registerNode('backgroundRect', {
            drawShape(cfg, group) {
                const path = group.addShape('rect', {
                    attrs: {
                        x: -cfg.width / 2,
                        y: -cfg.height / 2,
                        width: cfg.width,
                        height: cfg.height,
                        stroke: '#000',
                        lineWidth: 1,
                        strokeOpacity: 0,
                    },
                    name: cfg.name,
                });
                return path;
            },
        }, 'rect');

        //随机颜色
        function randomColor() {
            return 'rgb(' + Math.random() * 255 + ',' + Math.random() * 255 + ',' + Math.random() * 255 + ')';
        }

        const main = async () => {
            const dataManager = {
//                staticServer: 'http://39.155.169.121:9999',
                staticServer: 'http://10.1.117.43',
                graph: null,
                zoomLevelUpdated: false,
                previousZoomLevel: -1,
                zoomLevel: -1,
                previousCanvasTopLeftPoint: [],
                previousBackgroundRectXY: [],
                canvasTopLeftPoint: [],
                loadingTiles: false,
                loadingBureauPolygons: false,
                bureauPolygonNodes: [],
                loadingBureauKeyPoints: false,
                bureauKeyPointNodes: [],
                loadingTrainlineDepotStations: false,
                trainlineDepotStationNodes: [],

                refresh: function () {
                    const context = this;
                    context.previousCanvasTopLeftPoint = context.canvasTopLeftPoint;
                    context.refreshTiles();
                    context.refreshBureauPolygons();
                    context.refreshBureauKeyPoints();
                    context.refreshTrainlineDepotStations();
                    const backgroundRect = context.graph.findById('backgroundRect');
                    context.previousBackgroundRectXY = [backgroundRect.getModel().x, backgroundRect.getModel().y];
                },
                //加载背景瓦片
                refreshTiles: function () {
                    const doRefresh = async (context) => {
                        var isloading = context.loadingTiles;
                        if (isloading) {
                            return;
                        }

                        if (!context.zoomLevelUpdated) {
                            return;
                        }

                        const staticServer = context.staticServer;
                        const graph = context.graph;
                        const backgroundCombo = graph.findById('backgroundCombo');
                        const group = backgroundCombo.getContainer();

                        const zoomLevel = dataManager.zoomLevel;
                        const previousZoomLevel = dataManager.previousZoomLevel;

                        function clear() {
                            for (var index = group.getChildren().length; index > 0; index--) {
                                const node = group.getChildByIndex(index);
                                group.removeChild(node);
                                graph.removeItem(node);
                            }
                        }


                        if (zoomLevel < 5) {
                            clear();
                            const totalTiles = Math.pow(4, zoomLevel);
                            const rows = Math.sqrt(totalTiles);
                            const size = 256 / rows;
                            for (var index = 0; index < totalTiles; index++) {
                                const row = Math.floor(index / rows);
                                const column = index % rows;
                                if (zoomLevel < 3) {
                                    group.addShape('image', {
                                        attrs: {
                                            x: -128 + column * size,
                                            y: -128 + row * size,
                                            width: size,
                                            height: size,
                                            img: staticServer + "/image/china-map-" + zoomLevel + '-' + row + "-" + column + ".png",
                                        },
                                        draggable: true,
                                        name: 'backgroundCombo-background'
                                    });
                                }
                                if (zoomLevel >= 4 && zoomLevel < 5
                                    && (previousZoomLevel >= 5 || previousZoomLevel < 4)) {
                                    var k = 256 / 4.2;
                                    var deltaX = -11;
                                    var deltaY = 13;
                                    var shape = group.addShape('image', {
                                        attrs: {
                                            x: 128 - 2 * k + deltaX,
                                            y: -128 + deltaY,
                                            width: k,
                                            height: k,
                                            img: staticServer + '/image/china-map-4-0-0.png',
                                        },
                                        draggable: true,
                                        name: 'backgroundCombo-background'
                                    });
                                    shape.toBack();
                                    var shape = group.addShape('image', {
                                        attrs: {
                                            x: 128 - k + deltaX,
                                            y: -128 + deltaY,
                                            width: k,
                                            height: k,
                                            img: staticServer + '/image/china-map-4-1-0.png',
                                        },
                                        draggable: true,
                                        name: 'backgroundCombo-background'
                                    });
                                    shape.toBack();
                                    var shape = group.addShape('image', {
                                        attrs: {
                                            x: 128 - 2 * k + deltaX,
                                            y: -128 + k + deltaY,
                                            width: k,
                                            height: k,
                                            img: staticServer + '/image/china-map-4-0-1.png',
                                        },
                                        draggable: true,
                                        name: 'backgroundCombo-background'
                                    });
                                    shape.toBack();
                                    var shape = group.addShape('image', {
                                        attrs: {
                                            x: 128 - k + deltaX,
                                            y: -128 + k + deltaY,
                                            width: k,
                                            height: k,
                                            img: staticServer + '/image/china-map-4-1-1.png',
                                        },
                                        draggable: true,
                                        name: 'backgroundCombo-background'
                                    });
                                    shape.toBack();
                                }
                                group.addShape('rect', {
                                    attrs: {
                                        x: -128 + column * size,
                                        y: -128 + row * size,
                                        width: size,
                                        height: size,
                                        stroke: "red",
                                        lineWidth: 0.01,
                                    }
                                });
                                group.addShape('text', {
                                    attrs: {
                                        x: -128 + column * size,
                                        y: -128 + row * size,
                                        text: zoomLevel + '-' + row + "-" + column,
                                        fill: 'red',
                                        fontSize: 3,
                                        textAlign: 'left',
                                        textBaseline: 'top',
                                    },
                                });
                            }
                        }

//                        if (zoomLevel >= 0 && zoomLevel < 3
//                            && (previousZoomLevel >= 3 || previousZoomLevel < 0)) {
//                            clear();
//                            group.addShape('image', {
//                                attrs: {
//                                    x: -128,
//                                    y: -128,
//                                    width: 256,
//                                    height: 256,
//                                    img: staticServer + '/image/china-map-0-0-0.png',
//                                },
//                                draggable: true,
//                                name: 'backgroundCombo-background'
//                            });
//
//                        }
//                        if (zoomLevel >= 6 && zoomLevel < 18
//                            && (previousZoomLevel >= 18 || previousZoomLevel < 3)) {
//                            clear();
//                            var k = 256 / 4.2;
//                            var deltaX = -11;
//                            var deltaY = 13;
//                            group.addShape('image', {
//                                attrs: {
//                                    x: 128 - 2 * k + deltaX,
//                                    y: -128 + deltaY,
//                                    width: k,
//                                    height: k,
//                                    img: staticServer + '/image/china-map-1-0-0.png',
//                                },
//                                draggable: true,
//                                name: 'backgroundCombo-background'
//                            });
//                            group.addShape('image', {
//                                attrs: {
//                                    x: 128 - k + deltaX,
//                                    y: -128 + deltaY,
//                                    width: k,
//                                    height: k,
//                                    img: staticServer + '/image/china-map-1-1-0.png',
//                                },
//                                draggable: true,
//                                name: 'backgroundCombo-background'
//                            });
//                            group.addShape('image', {
//                                attrs: {
//                                    x: 128 - 2 * k + deltaX,
//                                    y: -128 + k + deltaY,
//                                    width: k,
//                                    height: k,
//                                    img: staticServer + '/image/china-map-1-0-1.png',
//                                },
//                                draggable: true,
//                                name: 'backgroundCombo-background'
//                            });
//                            group.addShape('image', {
//                                attrs: {
//                                    x: 128 - k + deltaX,
//                                    y: -128 + k + deltaY,
//                                    width: k,
//                                    height: k,
//                                    img: staticServer + '/image/china-map-1-1-1.png',
//                                },
//                                draggable: true,
//                                name: 'backgroundCombo-background'
//                            });
//                        }

//                        if (zoomLevel >= 19 && previousZoomLevel < 19) {
//                            clear();
//                        }

                        backgroundCombo.toBack();
                    };
                    doRefresh(this);
                },
                //加载bureau polygon
                refreshBureauPolygons: function () {
                    const doRefresh = async (context) => {
                        var isloading = context.loadingBureauPolygons;
                        if (isloading) {
                            return;
                        }

                        if (!context.zoomLevelUpdated) {
                            return;
                        }

                        const staticServer = context.staticServer;
                        const zoomLevel = context.zoomLevel;
                        const previousZoomLevel = context.previousZoomLevel;
                        const graph = context.graph;
                        const backgroundCombo = graph.findById('backgroundCombo');
                        const backgroundRect = graph.findById('backgroundRect');
                        const backgroundRectX = backgroundRect.getModel().x - 128;
                        const backgroundRectY = backgroundRect.getModel().y - 128;

                        //清除时机
                        if (previousZoomLevel >= 0 && previousZoomLevel < 3
                            && (zoomLevel >= 3 || zoomLevel < 0)) {
                            context.bureauPolygonNodes.forEach(node => {
                                backgroundCombo.removeChild(node);
                                graph.removeItem(node);
                            });
                            context.bureauPolygonNodes.length = 0;
                        }

                        //绘制时机
                        if (zoomLevel >= 0 && zoomLevel < 3
                            && (previousZoomLevel < 0 || previousZoomLevel >= 3)) {
                            const bureauPolygonResponse = await fetch(staticServer + '/file/bureauPolygonVos.json');
                            const bureauPolygonData = await bureauPolygonResponse.json();
                            bureauPolygonData.bureauPolygonVos.forEach(bureauPolygonVo => {
                                bureauPolygonVo.x += backgroundRectX;
                                bureauPolygonVo.y += backgroundRectY;
                                bureauPolygonVo.style.fill = randomColor();
                                bureauPolygonVo.style.stroke = bureauPolygonVo.style.fill;
                                const node = graph.addItem('node', bureauPolygonVo);
                                context.bureauPolygonNodes.push(node);
                                backgroundCombo.addChild(node);
                            });
                            backgroundRect.toBack();
                        }
                    };
                    doRefresh(this);
                },
                //加载bureau key point
                refreshBureauKeyPoints: function () {
                    const doRefresh = async (context) => {
                        var isloading = context.loadingBureauKeyPoints;
                        if (isloading) {
                            return;
                        }

                        if (!context.zoomLevelUpdated) {
                            return;
                        }

                        const staticServer = context.staticServer;
                        const zoomLevel = context.zoomLevel;
                        const previousZoomLevel = context.previousZoomLevel;
                        const graph = context.graph;
                        const backgroundCombo = graph.findById('backgroundCombo');
                        const backgroundRect = graph.findById('backgroundRect');
                        const backgroundRectX = backgroundRect.getModel().x - 128;
                        const backgroundRectY = backgroundRect.getModel().y - 128;

                        //清除时机
                        if (previousZoomLevel >= 0 && previousZoomLevel < 20
                            && (zoomLevel >= 20 || zoomLevel < 0)) {
                            context.bureauKeyPointNodes.forEach(node => {
                                backgroundCombo.removeChild(node);
                                graph.removeItem(node);
                            });
                            context.bureauKeyPointNodes.length = 0;
                        }


                        //绘制时机
                        if (zoomLevel >= 0 && zoomLevel < 20
                            && (previousZoomLevel < 0 || previousZoomLevel >= 20)) {
                            const bureauKeyPointResponse = await fetch(staticServer + '/file/bureauKeyPointVos.json');
                            const bureauKeyPointData = await bureauKeyPointResponse.json();
                            bureauKeyPointData.bureauKeyPointVos.forEach(bureauKeyPointVo => {
                                bureauKeyPointVo.x += backgroundRectX;
                                bureauKeyPointVo.y += backgroundRectY;
                                const node = graph.addItem('node', bureauKeyPointVo);
                                context.bureauKeyPointNodes.push(node);
                                backgroundCombo.addChild(node);
                            });
                            backgroundCombo.toBack();
                        } else {
                            context.bureauKeyPointNodes.forEach(node => {
                                node.getModel().size = 3 / graph.getZoom();
                                node.getModel().style.lineWidth = node.getModel().size;
                                node.update(node.getModel());
                            });
                        }
                    };
                    doRefresh(this);
                },
                //加载trainline depot stations
                refreshTrainlineDepotStations: function () {
                    const doRefresh = async (context) => {
                        var isloading = context.loadingTrainlineDepotStations;
                        if (isloading) {
                            return;
                        }

                        const staticServer = context.staticServer;
                        const graph = context.graph;
                        const zoomLevel = context.zoomLevel;
                        const previousZoomLevel = context.previousZoomLevel;
                        const previousCanvasTopLeftPoint = context.previousCanvasTopLeftPoint;
                        const pointByCanvas = graph.getPointByCanvas(0, 0);
                        const canvasTopLeftPoint = [pointByCanvas.x, pointByCanvas.y];
                        const trainlineDepotStationNodes = context.trainlineDepotStationNodes;

                        const topLeftPointByCanvas = graph.getPointByCanvas(0, 0);
                        const bottomRightPointByCanvas = graph.getPointByCanvas(graph.get('width'),
                            graph.get('height'));
                        const backgroundCombo = graph.findById('backgroundCombo');
                        const backgroundRect = graph.findById('backgroundRect');
                        const previousBackgroundRectXY = context.previousBackgroundRectXY;
                        const backgroundRectX = backgroundRect.getModel().x - 128;
                        const backgroundRectY = backgroundRect.getModel().y - 128;

                        var toClear = false;
                        var toLoad = false;
                        //时机
                        if (zoomLevel < 5 && previousZoomLevel >= 5) {
                            toClear = true;
                        }
                        if (zoomLevel >= 5 && previousZoomLevel < 5) {
                            toClear = true;
                            toLoad = true;
                        }
                        if (zoomLevel >= 5
                            && (canvasTopLeftPoint.x != previousCanvasTopLeftPoint.x
                            || canvasTopLeftPoint.y != previousCanvasTopLeftPoint.y
                            || backgroundRectX != previousBackgroundRectXY.x
                            || backgroundRectY != previousBackgroundRectXY.y)) {
                            toClear = true;
                            toLoad = true;
                        }
                        if (toClear) {
                            trainlineDepotStationNodes.forEach(node => {
                                backgroundCombo.removeChild(node);
                                graph.removeItem(node);
                            });
                            trainlineDepotStationNodes.length = 0;
                        }
                        if (toLoad) {
                            const trainlineDepotStationResponse = await fetch(
                                staticServer + '/file/trainlineDepotStationVos.json');
                            const trainlineDepotStationData = await
                                trainlineDepotStationResponse.json();
                            trainlineDepotStationNodes.length = 0;
                            trainlineDepotStationData.trainlineDepotStationVos.forEach(trainlineDepot => {
                                const color = randomColor();
                                trainlineDepot.forEach(trainlineDepotStationVo => {
                                    trainlineDepotStationVo.x += backgroundRectX;
                                    trainlineDepotStationVo.y += backgroundRectY;
                                    if (trainlineDepotStationVo.x > topLeftPointByCanvas.x
                                        && trainlineDepotStationVo.x < bottomRightPointByCanvas.x
                                        && trainlineDepotStationVo.y > topLeftPointByCanvas.y
                                        && trainlineDepotStationVo.y < bottomRightPointByCanvas.y) {
                                        trainlineDepotStationVo.style.stroke = color;
                                        trainlineDepotStationVo.style.fill = color;
                                        trainlineDepotStationVo.size = 0.03;
                                        trainlineDepotStationVo.style.lineWidth = 0.03;
                                        const node = graph.addItem('node', trainlineDepotStationVo);
                                        trainlineDepotStationNodes.push(node);
                                        backgroundCombo.addChild(node);
                                    }
                                });
                            });
                            backgroundCombo.toBack();
                        }
                    };
                    doRefresh(this);
                },
                //刷新缩放级别
                refreshZoomLevel: function () {
                    const zoom = graph.getZoom();

                    var zoomLevel = -1;
                    if (zoom >= 0) {
                        zoomLevel = 0;
                    }
                    if (zoom >= 2) {
                        zoomLevel = 1;
                    }
                    if (zoom >= 4) {
                        zoomLevel = 2;
                    }
                    if (zoom >= 8) {
                        zoomLevel = 3;
                    }
                    if (zoom >= 10) {
                        zoomLevel = 4;
                    }
                    if (zoom >= 100) {
                        zoomLevel = 5;
                    }
//                    if (zoom >= 10) {
//                        zoomLevel = 5;
//                    }
//                    if (zoom >= 12) {
//                        zoomLevel = 6;
//                    }
//                    if (zoom >= 14) {
//                        zoomLevel = 7;
//                    }
//                    if (zoom >= 16) {
//                        zoomLevel = 8;
//                    }
//                    if (zoom >= 18) {
//                        zoomLevel = 9;
//                    }
//                    if (zoom >= 20) {
//                        zoomLevel = 10;
//                    }
//                    if (zoom >= 22) {
//                        zoomLevel = 11;
//                    }
//                    if (zoom >= 24) {
//                        zoomLevel = 12;
//                    }
//                    if (zoom >= 26) {
//                        zoomLevel = 13;
//                    }
//                    if (zoom >= 28) {
//                        zoomLevel = 14;
//                    }
//                    if (zoom >= 30) {
//                        zoomLevel = 15;
//                    }
//                    if (zoom >= 32) {
//                        zoomLevel = 16;
//                    }
//                    if (zoom >= 34) {
//                        zoomLevel = 17;
//                    }
//                    if (zoom >= 100) {
//                        zoomLevel = 18;
//                    }
//                    if (zoom >= 300) {
//                        zoomLevel = 19;
//                    }

                    if (this.zoomLevel != zoomLevel) {
                        this.zoomLevelUpdated = true;
                        this.previousZoomLevel = this.zoomLevel;
                        this.zoomLevel = zoomLevel;
                        dataManager.refresh();
                        this.zoomLevelUpdated = false;
                    }
                },
            };

            const width = document.getElementById('mountNode').scrollWidth;
            const height = document.getElementById('mountNode').scrollHeight || document.getElementById(
                    'mountNode').parentNode.scrollHeight || (window.innerHeight );

            // 实例化 minimap 插件
            const minimap = new G6.Minimap({
                size: [300, 300 * height / width],
                className: 'minimap',
                type: 'delegate',
            });

            // 实例化 grid 插件
            const grid = new G6.Grid();

            //实例化绘图引擎
            const graph = new G6.Graph({
                container: 'mountNode',
                width: width,
                height: height,
                // Set groupByTypes to false to get rendering result with reasonable visual zIndex for combos
                groupByTypes: false,
                // 内置交互
                modes: {
                    default: [
                        'drag-canvas',
                        {
                            type: 'zoom-canvas',
                            sensitivity: 1,
                            minZoom: 1,
                            maxZoom: 300,
                        },
                        'drag-combo',
                        'click-select'],
                },
                defaultNode: {
                    style: {fillOpacity: 0.3, fill: "red", stroke: "red"},
                    stateStyles: {
                        hover: {fill: "lightsteelblue"},
                        selected: {stroke: "green", lineWidth: 3},
                    },
                    labelCfg: {
                        position: 'bottom',
                    },
                },
                minZoom: 1,
                maxZoom: 300,
                plugins: [grid, minimap], // 将 minimap 实例配置到图上
            });

            graph.on('dragend', e => {
                dataManager.refresh();
            });

            graph.on('click', e => {
                const nodeItem = e.item; // 获取鼠标离开的节点元素对象
            });

            //            // 鼠标离开节点
//            graph.on('node:mouseleave', e => {
//                const nodeItem = e.item; // 获取鼠标离开的节点元素对象
//                graph.setItemState(nodeItem, 'hover', false); // 设置当前节点的 hover 状态为 false
//            });

//            // 鼠标离开节点
//            graph.on('node:mouseleave', e => {
//                const nodeItem = e.item; // 获取鼠标离开的节点元素对象
//                graph.setItemState(nodeItem, 'hover', false); // 设置当前节点的 hover 状态为 false
//            });

            // 鼠标滚轮对图进行缩放后
            graph.on('wheelzoom', e => {
                dataManager.refreshZoomLevel();
            });

            graph.data({
                combos: [
                    {
                        id: 'backgroundCombo',
                        type: 'backgroundCombo',
                        x1: 0,
                        y1: 0,
                        width: width,
                        height: height,
                    },
                ],
                nodes: [
                    {
                        id: 'backgroundRect',
                        type: 'backgroundRect',
                        comboId: 'backgroundCombo',
                        x: width / 2,
                        y: height / 2,
                        width: width,
                        height: height,
                    },
                ],
            });
            graph.render();

            dataManager.graph = graph;
//            dataManager.refreshZoomLevel();

            const minimapElement = document.getElementsByClassName('minimap')[0];
            minimapElement.style.position = 'fixed';
            minimapElement.style.top = (height - 300 * height / width) + 'px';
            minimapElement.style.left = '0px';
            minimapElement.style.border = '2px solid #c0c0c0';
            minimapElement.style.zIndex = '9999';

            if (width < 512) {
                graph.zoomTo(1, {x: width / 2, y: height / 2});
                dataManager.refreshZoomLevel();
            } else if (width < 1024 && width >= 512) {
                graph.zoomTo(2, {x: width / 2, y: height / 2});
                dataManager.refreshZoomLevel();
            } else if (width >= 1024) {
                graph.zoomTo(4, {x: width / 2, y: height / 2 - 30});
                dataManager.refreshZoomLevel();
            }
        };
        main();

        //39.902802, 116.427048
    </script>
</body>
</html>