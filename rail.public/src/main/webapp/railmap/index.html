<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>示意图</title>
    <link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        body {
            margin: 0;
            overflow: hidden;
            background: #fff;
            width: 100%;
            height: 100%
        }

        #map {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .smControlOverviewMapElement canvas {
            background-color: black;
        }

        .smControlPanZoomBar {
            position: absolute;
            right: 100px;
            bottom: 150px;
        }

        .bureauButton {
            width: 25px;
            height: 30px;
            padding: 0px;
            margin: 0px 0px 5px 0px;
        }
    </style>
</head>
<body>
    <div style="position:absolute;left: 0px;top: 20px;width:auto;z-index:2;">
        <div style="position: absolute;left:20px;top: 0px;height: auto;">
            <div>
                <input id="searchKeyWordInput" type="text" autocomplete="off" maxlength="256" placeholder="搜车站、车务段等" value="" style="position:absolute;left: 0px;width: 150px;height: 30px">
                <button class="fa fa-random" style="position:absolute;left: 154px;width: 36px;height: 36px" title="找径路"></button>
                <button class="fa fa-search" style="position:absolute;left: 190px;width: 36px;height: 36px" title="搜索" onclick="searchOnClick(event)"></button>
            </div>
            <div id="searchResultDiv" style="margin-top: 40px;width:326px;background-color: #ffffff;display: none;" data-visible="false">
                <div style="padding-bottom: 25px">
                    <button style="position:absolute;right: 0px" class="fa fa-times" onclick="closeSearchResultDiv(event)"></button>
                </div>
                <hr style="margin: 0px 1px 10px 1px" />
                <div>
                    <select id="searchResultSelect" size="10" onchange="searchResultSelectOnchange(event)" style="border:none;outline: none;margin-top:  0px;width:100%;height:auto;z-index:2;">
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div style="position:absolute;right: 250px;top: 20px;width:auto;z-index:2;">
        <div style="position: absolute;top: 0px;height: auto;">
            <div>
                <button id="locationButton" class="" style="position:absolute;left: 0px;width: 134px;height: 36px">
                    全路
                </button>
                <button id="highlightButton" class="fa fa-star-o" style="position:absolute;left: 134px;width: 30px;height: 36px" title="高亮路局车务段" onclick="highlightOnclick(event)"></button>
                <button id="locationBarButton" onclick="setLocationDivVisible(event)" class="fa fa-bars" style="position:absolute;left: 164px;width: 30px;height: 36px" onclick="highlightOnclick(event)"></button>
                <button class="fa fa-briefcase" onclick="setSettingDivVisible(event)" style="position:absolute;left: 194px;width: 36px;height: 36px" onclick="setSettingDivVisible(event)">
                </button>
            </div>
            <div id="locationDiv" style="background-color: #ffffff;display: none;" data-visible="false">
                <div style="margin-top: 40px;margin-bottom: 0px">
                    <button style="position:absolute;right: 0px" class="fa fa-times" onclick="setLocationDivInvisible(event)"></button>
                </div>
                <div style="padding-top: 15px;">
                    <hr />
                </div>
                <div style="margin: 5px 5px 5px 0px;height:50px;" onclick="bureauSelectOnchange(event)">
                    <div>
                        <button style="position:absolute;left:0px;margin-left: 4px;width: 25px;height:25px;" class="bureauButton" value="1">
                            哈
                        </button>
                        <button style="position:absolute;left:25px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="2">
                            沈
                        </button>
                        <button style="position:absolute;left:50px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="3">
                            京
                        </button>
                        <button style="position:absolute;left:75px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="4">
                            太
                        </button>
                        <button style="position:absolute;left:100px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="5">
                            呼
                        </button>
                        <button style="position:absolute;left:125px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="6">
                            郑
                        </button>
                        <button style="position:absolute;left:150px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="7">
                            武
                        </button>
                        <button style="position:absolute;left:175px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="8">
                            西
                        </button>
                        <button style="position:absolute;left:200px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="9">
                            济
                        </button>
                    </div>
                    <div style="padding-top:30px">
                        <button style="position:absolute;left:0px;margin-left: 4px;width: 25px;height:25px;" class="bureauButton" value="10">
                            上
                        </button>
                        <button style="position:absolute;left:25px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="11">
                            南
                        </button>
                        <button style="position:absolute;left:50px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="12">
                            广
                        </button>
                        <button style="position:absolute;left:75px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="13">
                            宁
                        </button>
                        <button style="position:absolute;left:100px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="14">
                            成
                        </button>
                        <button style="position:absolute;left:125px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="15">
                            昆
                        </button>
                        <button style="position:absolute;left:150px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="16">
                            兰
                        </button>
                        <button style="position:absolute;left:175px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="17">
                            乌
                        </button>
                        <button style="position:absolute;left:200px;margin-left: 0px;width: 25px;height:25px;" class="bureauButton" value="18">
                            青
                        </button>
                    </div>
                </div>
                <div style="padding-top: 0px">
                    <hr />
                </div>
                <div>
                    <select id="trainlineDepotSelect" size="10" onchange="trainlineDepotSelectOnchange(event)" style="border:none;outline: none;margin: 0px 0px 0px 10px;width:220px;height:200px;z-index:2;">
                    </select>
                </div>
            </div>
            <div id="settingDiv" style="width:220px;background-color: #ffffff;display: none;" data-visible="false">
                <div style="margin-top: 40px;margin-bottom: 40px">
                    <button style="position:absolute;right: 0px" class="fa fa-times" onclick="setSettingDivInvisible(event)"></button>
                </div>
                <div style="padding-top: 15px">
                    <hr />
                </div>
                <div style="margin:10px;padding-bottom: 10px">
                    <input type="button" style="width:45px;height: 45px;padding-right: 5px;" class="btn btn-default" value="新增" onclick="activateAddFeature()" />
                    <input type="button" style="width:45px;height: 45px;padding-right: 5px;" class="btn btn-default" value="选择" onclick="activateSelectedFeature()" />
                    <input type="button" style="width:45px;height: 45px;padding-right: 5px;" class="btn btn-default" value="编辑" onclick="editselectedFeature()" />
                    <input type="button" style="width:45px;height: 45px;" class="btn btn-default" value="删除" onclick="deleteSelectedFeature()" />
                </div>
            </div>
        </div>
    </div>
    <div id="map" style="background-color: black"></div>
    <script type="text/javascript" src="assets/iclient8c/libs/SuperMap.Include.js"></script>
    <script type="text/javascript">
        var host = window.location.hostname === '39.155.169.121' ? 'http://39.155.169.121:9998' : 'http://10.9.3.111:8090';
        var host = "http://39.155.169.121:9998";
        //        var host = "http://localhost:8090";
        var map, local, layer, markerLayer, vectorLayer,
            bureauVectorLayer, trainOperationDepotVectorLayer, trainlineDepotVectorLayer,
            selectPolygon, drawPolygon, dataUrl, ids, modifyFeature,
//            staticServer = 'http://39.155.169.121:9998',
            staticServer = 'http://10.1.117.43',
            style = {
                strokeColor: "#red",
                strokeWidth: 5,
                pointerEvents: "visiblePainted",
                fillColor: "#ff0000",
                fillOpacity: 0.5,
                pointRadius: 2
            },
            mapUrl = host + "/iserver/services/map-rail/rest/maps/map_simple",
            mapRestUrl = host + "/iserver/services/map-rail/rest/maps/map_simple",
            mapDataUrl = host + "/iserver/services/data-rail/rest/data/",
            mapDataRestUrl = host + "/iserver/services/data-rail/rest/data/datasources/rail/datasets/polygon";
        init();

        function init() {
            layer = new SuperMap.Layer.TiledDynamicRESTLayer("铁路", mapUrl, {
                cacheEnabled: false
            }, {maxResolution: "auto", bufferImgCount: 0}); //将bufferImgCount设置为0，不使用缓存，编辑后，刷新图层，永远请求最新的图片
            layer.events.on({"layerInitialized": addLayer});

            markerLayer = new SuperMap.Layer.Markers("MarkerL ayer");
            vectorLayer = new SuperMap.Layer.Vector("Vector Layer");
            vectorLayer.events.on({"afterfeaturemodified": editFeatureCompleted});
            bureauVectorLayer = new SuperMap.Layer.Vector("Bureau Vector Layer");

            selectPolygon = new SuperMap.Control.DrawFeature(vectorLayer, SuperMap.Handler.Point);
            selectPolygon.events.on({"featureadded": selectedFeatureCompleted});

            drawPolygon = new SuperMap.Control.DrawFeature(vectorLayer, SuperMap.Handler.Polygon);
            drawPolygon.events.on({"featureadded": addFeatureCompleted});

            map = new SuperMap.Map("map", {
                minZoom: 3,
                controls: [
                    new SuperMap.Control.ScaleLine(),
                    new SuperMap.Control.Navigation({
                        dragPanOptions: {
                            enableKinetic: true
                        }
                    }),
                    selectPolygon, drawPolygon]
            });

            //初始化复杂缩放控件类
            var panzoombar = new SuperMap.Control.PanZoomBar();
            // 是否固定缩放级别为[0,16]之间的整数，默认为false
            panzoombar.forceFixedZoomLevel = false;
            //是否显示滑动条，默认值为false
            panzoombar.showSlider = false;
            /*点击箭头移动地图时，所移动的距离占总距离（上下移动的总距离为高度，左右移动的总距离为宽度）
             的百分比，默认为null。 例如：如果slideRatio 设为0.5, 则垂直上移地图半个地图高度.*/
            panzoombar.slideRatio = 0.5;
            //设置缩放条滑块的高度，默认为120
            panzoombar.sliderBarHeight = 180;
            //设置缩放条滑块的宽度，默认为13
            panzoombar.sliderBarWidth = 17;
            map.addControl(panzoombar);

            //初始化鹰眼控件类
            var overviewmap = new SuperMap.Control.OverviewMap();
            //属性minRectSize：鹰眼范围矩形边框的最小的宽度和高度。默认为8pixels
            overviewmap.minRectSize = 20;
            overviewmap.minRatio = 50;
//            map.addControl(overviewmap);

            modifyFeature = new SuperMap.Control.ModifyFeature(vectorLayer);
            map.addControl(modifyFeature);

//            map.addControl(new SuperMap.Control.LayerSwitcher(), new SuperMap.Pixel(42, 80));

            map.events.on({
                "moveend": function (event) {
                    queryNeareastLocation();
                }
            });  //添加click事件
            map.events.on({
                "zoomend": function (event) {
                    queryNeareastLocation();
                }
            });  //添加click事件
        }

        function addLayer() {
            map.addLayers([layer, markerLayer, bureauVectorLayer, vectorLayer]);
            map.setCenter(new SuperMap.LonLat("11589611.5396656", "4737184.82796693"), 4);
        }

        //激活添加地物
        function activateAddFeature() {
            //先清除上次的显示结果
            clearAllDeactivate();
            drawPolygon.activate();
        }

        //执行添加地物
        function addFeatureCompleted(drawGeometryArgs) {
            drawPolygon.deactivate();
            var geometry = drawGeometryArgs.feature.geometry,
                feature = new SuperMap.Feature.Vector();
            feature.geometry = drawGeometryArgs.feature.geometry,
                feature.style = style;
            vectorLayer.addFeatures(feature);

            geometry.SRID = 3857;
            var editFeatureParameter,
                editFeatureService,
                features = {
                    fieldNames: [],
                    fieldValues: [],
                    geometry: geometry
                };
            editFeatureParameter = new SuperMap.REST.EditFeaturesParameters({
                features: [features],
                editType: SuperMap.REST.EditType.ADD,
                returnContent: false
            });
            editFeatureService = new SuperMap.REST.EditFeaturesService(mapDataRestUrl, {
                eventListeners: {
                    "processCompleted": addFeaturesProcessCompleted,
                    "processFailed": processFailed
                }
            });
            editFeatureService.processAsync(editFeatureParameter);
        }

        //添加地物成功
        function addFeaturesProcessCompleted(editFeaturesEventArgs) {
            var addResultIds = editFeaturesEventArgs.result.IDs,
                resourceInfo = editFeaturesEventArgs.result.resourceInfo;
            if (addResultIds === null && resourceInfo === null) return;

            if ((addResultIds && addResultIds.length > 0) || (resourceInfo && resourceInfo.succeed)) {
                vectorLayer.removeAllFeatures();
                //重新加载图层
                layer.redraw();
            } else {
                console.log("addFeaturesProcessCompleted false");
            }

        }

        function processFailed(e) {
            console.log("processFailed");
        }

        //激活选择地物
        function activateSelectedFeature() {
            clearAllDeactivate();
            selectPolygon.activate();
        }

        //执行选择地物
        function selectedFeatureCompleted(drawGeometryArgs) {
            selectPolygon.deactivate();
            var getFeaturesByGeometryParams,
                getFeaturesByGeometryService,
                geometry = drawGeometryArgs.feature.geometry;
            geometry.SRID = 3857;
            getFeaturesByGeometryParams = new SuperMap.REST.GetFeaturesByGeometryParameters({
                datasetNames: ["rail:polygon"],
                spatialQueryMode: SuperMap.REST.SpatialQueryMode.INTERSECT,
                geometry: geometry
            });
            getFeaturesByGeometryService = new SuperMap.REST.GetFeaturesByGeometryService(mapDataUrl, {
                eventListeners: {
                    "processCompleted": selectedFeatureProcessCompleted,
                    "processFailed": processFailed
                }
            });
            getFeaturesByGeometryService.processAsync(getFeaturesByGeometryParams);
        }

        //选择地物完成
        function selectedFeatureProcessCompleted(getFeaturesEventArgs) {
            var features,
                feature,
                i, len,
                originFeatures = getFeaturesEventArgs.originResult.features,
                result = getFeaturesEventArgs.result;
            vectorLayer.removeAllFeatures();

            if (originFeatures === null || originFeatures.length === 0) {
                return;
            }
            ids = new Array();
            //将当前选择的地物的ID保存起来，以备删除地物使用,并在编辑地物中使之为null，以免编辑地物后在不选择地物时将所编辑的地物删除
            for (i = 0, len = originFeatures.length; i < len; i++) {
                ids.push(originFeatures[i].ID);
            }
            if (result && result.features) {
                features = result.features;
                for (var j = 0, len = features.length; j < len; j++) {
                    feature = features[j];
                    feature.geometry.transform(
                        new SuperMap.Projection("EPSG:4326"),
                        new SuperMap.Projection("EPSG:3857"));
                    feature.style = style;
                    vectorLayer.addFeatures(feature);
                }
            }

            selectPolygon.activate();
        }

        //激活编辑地物
        function editselectedFeature() {
            clearAllDeactivate();
            if (ids == null) {
            } else {
                modifyFeature.activate();
            }
        }

        //执行地物编辑
        function editFeatureCompleted(event) {
            modifyFeature.deactivate();
            var editFeatureParameter,
                editFeatureService,
                features,
                attributes,
                feature = event.feature;

            feature.geometry.SRID = 3857;
            attributes = feature.attributes;
            var attrNames = [];
            var attrValues = [];
            for (var attr in attributes) {
                attrNames.push(attr);
                attrValues.push(attributes[attr]);
            }
            features = {
                fieldNames: attrNames,
                fieldValues: attrValues,
                geometry: event.feature.geometry
            };
            features.geometry.id = feature.fid;
            editFeatureParameter = new SuperMap.REST.EditFeaturesParameters({
                features: [features],
                editType: SuperMap.REST.EditType.UPDATE
            });
            editFeatureService = new SuperMap.REST.EditFeaturesService(mapDataRestUrl, {
                eventListeners: {
                    "processCompleted": updateFeaturesProcessCompleted,
                    "processFailed": processFailed
                }
            });
            editFeatureService.processAsync(editFeatureParameter);
        }

        //更新地物完成
        function updateFeaturesProcessCompleted(editFeaturesEventArgs) {
            if (editFeaturesEventArgs.result.resourceInfo.succeed) {
                //重新加载图层
                vectorLayer.removeAllFeatures();
                layer.redraw();
                //使Ids为空，以免编辑地物后在不选择地物时将所编辑的地物删除
                ids = null;
            } else {
                console.log("updateFeaturesProcessCompleted false");
            }
        }

        //删除选中地物
        function deleteSelectedFeature() {
            clearAllDeactivate();
            if (ids == null) {
            } else {
                var editFeatureParameter,
                    editFeatureService;
                editFeatureParameter = new SuperMap.REST.EditFeaturesParameters({
                    IDs: ids,
                    editType: SuperMap.REST.EditType.DELETE
                });
                editFeatureService = new SuperMap.REST.EditFeaturesService(mapDataRestUrl, {
                    eventListeners: {
                        "processCompleted": deleteFeaturesProcessCompleted,
                        "processFailed": processFailed
                    }
                });
                editFeatureService.processAsync(editFeatureParameter);
            }

        }

        //删除地物完成
        function deleteFeaturesProcessCompleted(editFeaturesEventArgs) {
            if (editFeaturesEventArgs.result.resourceInfo.succeed) {
                console.log("deleteFeaturesProcessCompleted true");
                //重新加载图层
                vectorLayer.removeAllFeatures();
                layer.redraw();
            }
            else {
                console.log("deleteFeaturesProcessCompleted false");
            }
        }

        function clearVectors(event) {
            vectorLayer.removeAllFeatures();
        }

        function closeSearchResultDiv(event) {
            const div = document.getElementById("searchResultDiv");

            div.style.display = 'none';
            div.dataset.visible = "false";
        }

        //SQL查询
        function searchOnClick(event) {
            const keyWord = document.getElementById("searchKeyWordInput").value;
            if (keyWord.trim().length == 0) {
                return;
            }

            // 查询路局
            var queryParam, queryBySQLParams, queryBySQLService;
            // 初始化查询参数
            queryParam = new SuperMap.REST.FilterParameter({
                name: "bureau@rail",
                attributeFilter: "NAME like '%" + keyWord + "%'"
            });
            // 初始化sql查询参数
            queryBySQLParams = new SuperMap.REST.QueryBySQLParameters({
                queryParams: [queryParam]
            });
            // SQL查询服务
            queryBySQLService = new SuperMap.REST.QueryBySQLService(mapRestUrl, {
                eventListeners: {"processCompleted": processCompleted, "processFailed": processFailed}
            });
            queryBySQLService.processAsync(queryBySQLParams);

            // 查询车务段
            var queryParam, queryBySQLParams, queryBySQLService;
            // 初始化查询参数
            queryParam = new SuperMap.REST.FilterParameter({
                name: "trainoperationdepot@rail",
                attributeFilter: "NAME like '%" + keyWord + "%'"
            });
            // 初始化sql查询参数
            queryBySQLParams = new SuperMap.REST.QueryBySQLParameters({
                queryParams: [queryParam]
            });
            // SQL查询服务
            queryBySQLService = new SuperMap.REST.QueryBySQLService(mapRestUrl, {
                eventListeners: {"processCompleted": processCompleted, "processFailed": processFailed}
            });
            queryBySQLService.processAsync(queryBySQLParams);

            // 查询行调台
            var queryParam, queryBySQLParams, queryBySQLService;
            // 初始化查询参数
            queryParam = new SuperMap.REST.FilterParameter({
                name: "trainlinedepot@rail",
                attributeFilter: "DDT_NAME like '%" + keyWord + "%'"
            });
            // 初始化sql查询参数
            queryBySQLParams = new SuperMap.REST.QueryBySQLParameters({
                queryParams: [queryParam]
            });
            // SQL查询服务
            queryBySQLService = new SuperMap.REST.QueryBySQLService(mapRestUrl, {
                eventListeners: {"processCompleted": processCompleted, "processFailed": processFailed}
            });
            queryBySQLService.processAsync(queryBySQLParams);

            // 查询车站
            var queryParam, queryBySQLParams, queryBySQLService;
            // 初始化查询参数
            queryParam = new SuperMap.REST.FilterParameter({
                name: "station@rail",
                attributeFilter: "NAME like '%" + keyWord + "%'"
            });
            // 初始化sql查询参数
            queryBySQLParams = new SuperMap.REST.QueryBySQLParameters({
                queryParams: [queryParam]
            });
            // SQL查询服务
            queryBySQLService = new SuperMap.REST.QueryBySQLService(mapRestUrl, {
                eventListeners: {"processCompleted": processCompleted, "processFailed": processFailed}
            });
            queryBySQLService.processAsync(queryBySQLParams);

            const div = document.getElementById("searchResultDiv");
            div.style.display = 'block';
            div.dataset.visible = "true";
            const searchResultSelect = document.getElementById("searchResultSelect");
            searchResultSelect.options.length = 0;
        }

        //SQL查询(县)成功时触发此事件
        function processCompleted(queryEventArgs) {
            const searchResultSelect = document.getElementById("searchResultSelect");

            var i, j, feature,
                result = queryEventArgs.result;
            if (result && result.recordsets) {
                for (i = 0; i < result.recordsets.length; i++) {
                    if (result.recordsets[i].features) {
                        for (j = 0; j < result.recordsets[i].features.length; j++) {
                            feature = result.recordsets[i].features[j];
                            var option = document.createElement("option");
                            option.text = feature.data.NAME;
                            option.dataset.x = feature.geometry.x;
                            option.dataset.y = feature.geometry.y;
                            searchResultSelect.add(option, null);
                        }
                    }
                }
            }
        }

        //SQL查询(县)失败时出发的事件
        function processFailed(e) {
            console.log("query error");
        }

        function searchResultSelectOnchange(event) {
            clearVectors(event);

            const selectedOption = event.target.selectedOptions[0];
            var lon = selectedOption.dataset.x;
            var lat = selectedOption.dataset.y;
            var point = new SuperMap.Geometry.Point(lon, lat);
            var pointVector = new SuperMap.Feature.Vector(point);
            pointVector.style = {
                fillColor: "red",
                strokeColor: "red",
                pointRadius: 2
            };
            vectorLayer.addFeatures([pointVector]);
            map.panTo(new SuperMap.LonLat(lon, lat));
        }

        function clearAllDeactivate() {
            modifyFeature.deactivate();
            selectPolygon.deactivate();
            drawPolygon.deactivate();
        }

        function setLocationDivVisible(event) {
            setSettingDivInvisible(event);
            const div = document.getElementById("locationDiv");
            div.style.display = 'block';
            div.dataset.visible = "true";
        }


        function setLocationDivInvisible(event) {
            clearVectors(event);
            const div = document.getElementById("locationDiv");
            div.style.display = 'none';
            div.dataset.visible = "false";
        }

        function setSettingDivVisible(event) {
            setLocationDivInvisible(event);
            const div = document.getElementById("settingDiv");
            div.style.display = 'block';
            div.dataset.visible = "true";
        }

        function setSettingDivInvisible(event) {
            const div = document.getElementById("settingDiv");
            div.style.display = 'none';
            div.dataset.visible = "false";
        }


        function highlightOnclick(event) {
            const classList = event.target.classList;
            if (classList.contains("fa-star-o")) {
                classList.remove('fa-star-o');
                classList.add('fa-star');
            }
            else if (classList.contains("fa-star")) {
                classList.remove('fa-star');
                classList.add('fa-star-o');
            }
            event.target.dataset.bureauCode = 0;
            event.target.dataset.trainlindeDepotId = 0;
            queryNeareastLocation();
        }

        //查询最近地物
        function queryNeareastLocation() {
            const locationButton = document.getElementById("locationButton");

            const highlightButton = document.getElementById("highlightButton");
            const highlight = highlightButton.classList.contains("fa-star");


            if (map.getZoom() < 7) {
                locationButton.textContent = "全路";
                highlightButton.dataset.bureauCode = 0;
                highlightButton.dataset.trainlindeDepotId = 0;
                bureauVectorLayer.removeAllFeatures();
                return;
            }

            if (!highlight) {
                highlightButton.dataset.bureauCode = 0;
                highlightButton.dataset.trainlindeDepotId = 0;
                bureauVectorLayer.removeAllFeatures();
                return;
            }

            if (map.getZoom() < 9) {
                queryNeareastFeature("bureau@rail", function (queryEventArgs) {
                    const recordsets = queryEventArgs.result.recordsets;
                    if (recordsets.length == 1 && recordsets[0].features.length) {
                        locationButton.textContent = recordsets[0].features[0].attributes["NAME"];

                        if (highlightButton.dataset.trainlineDepotId != 0) {
                            highlightButton.dataset.bureauCode = 0;
                            highlightButton.dataset.trainlineDepotId = 0;
                            bureauVectorLayer.removeAllFeatures();
                        }

                        const bureauCode = recordsets[0].features[0].attributes["CODE"];
                        if (highlightButton.dataset.bureauCode != bureauCode) {
                            highlightButton.dataset.bureauCode = bureauCode;

                            bureauVectorLayer.removeAllFeatures();
                            highlightTrainOperationDepot();
                        }
                    }
                });
                return;
            }

            queryNeareastFeature("trainlineDepot@rail", function (trainlineDepotQueryEventArgs) {
                const trainlineDepotRecordsets = trainlineDepotQueryEventArgs.result.recordsets;
                if (trainlineDepotRecordsets.length == 1 && trainlineDepotRecordsets[0].features.length) {
                    const bureauCode = trainlineDepotRecordsets[0].features[0].attributes["BUREAU_CODE"];
                    const bureauButtons = document.getElementsByClassName("bureauButton");
                    var bureauShortName = "";
                    for (var index = 0; index < bureauButtons.length; index++) {
                        if (bureauButtons[index].value == bureauCode) {
                            bureauShortName = bureauButtons[index].textContent;
                            const bureauCode = trainlineDepotRecordsets[0].features[0].attributes["BUREAU_CODE"];
                            const trainlineDepotId = trainlineDepotRecordsets[0].features[0].attributes["DDT_ID"];
                            const trainlineDepotName = trainlineDepotRecordsets[0].features[0].attributes["DDT_NAME"];

                            locationButton.textContent = bureauShortName + " - " + trainlineDepotName;

                            if (highlightButton.dataset.bureauCode != bureauCode
                                || highlightButton.dataset.trainlineDepotId != trainlineDepotId) {
                                highlightButton.dataset.bureauCode = bureauCode;
                                highlightButton.dataset.trainlineDepotId = trainlineDepotId;

                                bureauVectorLayer.removeAllFeatures();
                                highlightTrainlineDepot();
                            }
                            return;
                        }
                    }
                }
            });

            function queryNeareastFeature(dataset, queryCompletedFunction, queryFailedFunction) {
                const lngLat = map.getCenter().transform(new SuperMap.Projection("EPSG:3857"),
                    new SuperMap.Projection("EPSG:4326"));

                var centerPoint = new SuperMap.Geometry.Point(lngLat.lon, lngLat.lat);
                centerPoint.SRID = 4326;

                var queryByDistanceParams = new SuperMap.REST.QueryByDistanceParameters({
                    queryParams: [{name: dataset}],
                    returnContent: true,
                    expectCount: 1,
                    isNearest: true,
                    prjCoordSys: {"epsgCode": 4326},
                    distance: 50,//10度范围
                    geometry: centerPoint
                });

                var queryByDistanceService = new SuperMap.REST.QueryByDistanceService(mapRestUrl);
                queryByDistanceService.events.on({
                    "processCompleted": queryCompletedFunction,
                    "processFailed": queryFailedFunction
                });

                queryByDistanceService.processAsync(queryByDistanceParams);
            }
        }

        //高亮车务段
        function highlightTrainOperationDepot() {
            const highlightButton = document.getElementById("highlightButton");

            const bureauCode = highlightButton.dataset.bureauCode;

            // 查询路局
            var queryParam, queryBySQLParams, queryBySQLService;
            // 初始化查询参数
            queryParam = new SuperMap.REST.FilterParameter({
                name: "trainoperationdepot@rail",
                attributeFilter: "BUREAU_CODE = " + bureauCode + ""
            });
            // 初始化sql查询参数
            queryBySQLParams = new SuperMap.REST.QueryBySQLParameters({
                queryParams: [queryParam]
            });
            // SQL查询服务
            queryBySQLService = new SuperMap.REST.QueryBySQLService(mapRestUrl, {
                eventListeners: {
                    "processCompleted": function (queryEventArgs) {
                        const searchResultSelect = document.getElementById("searchResultSelect");

                        var i, j, feature,
                            result = queryEventArgs.result;
                        if (result && result.recordsets) {
                            for (i = 0; i < result.recordsets.length; i++) {
                                if (result.recordsets[i].features) {
                                    for (j = 0; j < result.recordsets[i].features.length; j++) {
                                        feature = result.recordsets[i].features[j];
                                        bureauVectorLayer.addFeatures(createVectorFeature(feature));
                                    }
                                }
                            }
                        }
                    },
                    "processFailed": function (e) {
                        console.log("highlightTrainOperationDepot error");
                    }
                }
            });
            queryBySQLService.processAsync(queryBySQLParams);

            function createVectorFeature(feature) {
                //点对象
                var lonLat = new SuperMap.LonLat(feature.geometry.x, feature.geometry.y);
                var point = new SuperMap.Geometry.Point(lonLat.lon, lonLat.lat);
                var pointVector = new SuperMap.Feature.Vector(point);
                pointVector.style = {
                    fillColor: "#13FF41",
                    strokeColor: "#13FF41",
                    pointRadius: 4
                };
                return pointVector;
            }
        }

        //高亮行调台
        function highlightTrainlineDepot() {
            const main = async () => {

                const highlightButton = document.getElementById("highlightButton");

                const bureauCode = highlightButton.dataset.bureauCode;
                const trainlineDeportId = highlightButton.dataset.trainlineDepotId;

                const trainlineDepotEntryResponse = await fetch(
                    staticServer + '/file/trainlinedepot/' + bureauCode + "/depot" + trainlineDeportId + '.json');
                const trainlineDepotEntryData = await trainlineDepotEntryResponse.json();

                trainlineDepotEntryData.entries.forEach(entry => {
                    //点对象
                    var lonLat = new SuperMap.LonLat(entry.lng, entry.lat).transform(
                        new SuperMap.Projection("EPSG:4326"),
                        new SuperMap.Projection("EPSG:3857")
                    );
                    var point = new SuperMap.Geometry.Point(lonLat.lon, lonLat.lat);
                    var pointVector = new SuperMap.Feature.Vector(point);
                    pointVector.style = {
                        fillColor: "#13FF41",
                        strokeColor: "#13FF41",
                        pointRadius: 2
                    };
                    bureauVectorLayer.addFeatures([pointVector]);
                });
            };
            main();
        }

        function bureauSelectOnchange(event) {
            if (!event.target.classList.contains("bureauButton")) {
                return;
            }

            const main = async () => {
                document.getElementById("locationButton").textContent = event.target.textContent;
                const bureauCode = event.target.value;
                const trainlineDepotSelect = document.getElementById("trainlineDepotSelect");
                trainlineDepotSelect.options.length = 0;

                const trainlineDepotResponse = await fetch(
                    staticServer + '/file/trainlinedepot/' + bureauCode + '/depots.json');
                const trainlineDepotData = await trainlineDepotResponse.json();

                trainlineDepotSelect.dataset.bureauCode = bureauCode;
                trainlineDepotSelect.dataset.bureauShortName = event.target.textContent;

                trainlineDepotData.depots.forEach(depot => {
                    var option = document.createElement("option");
                    option.text = depot.ddtName;
                    option.value = depot.ddtId;
                    trainlineDepotSelect.add(option, null);
                });
            };
            main();
        }

        function trainlineDepotSelectOnchange(event) {
            const main = async () => {
                clearVectors(event);

                const bureauCode = event.target.dataset.bureauCode;
                const selectedOption = event.target.selectedOptions[0];
                const locationButton = document.getElementById("locationButton");
                locationButton.textContent = event.target.dataset.bureauShortName + " - " + selectedOption.textContent;
                const depotId = selectedOption.value;

                const trainlineDepotEntryResponse = await fetch(
                    staticServer + '/file/trainlinedepot/' + bureauCode + "/depot" + depotId + '.json');
                const trainlineDepotEntryData = await trainlineDepotEntryResponse.json();

                var lon = 0;
                var lat = 0;
                trainlineDepotEntryData.entries.forEach(entry => {
                    //点对象
                    var lonLat = new SuperMap.LonLat(entry.lng, entry.lat).transform(
                        new SuperMap.Projection("EPSG:4326"),
                        new SuperMap.Projection("EPSG:3857")
                    );
                    var point = new SuperMap.Geometry.Point(lonLat.lon, lonLat.lat);
                    var pointVector = new SuperMap.Feature.Vector(point);
                    pointVector.style = {
                        fillColor: "red",
                        strokeColor: "red",
                        pointRadius: 2
                    };
                    vectorLayer.addFeatures([pointVector]);

                    lon += lonLat.lon;
                    lat += lonLat.lat;
                });

                const length = trainlineDepotEntryData.entries.length;
                map.panTo(new SuperMap.LonLat(lon / length, lat / length));
                map.zoomTo(9);


            };
            main();
        }
    </script>
</body>
</html>